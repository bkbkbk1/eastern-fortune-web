import OpenAI from 'openai';
import { SajuPillars } from './saju-calculator';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY!
});

export interface FortuneResult {
  // 기본 정보
  overall: string;

  // 주요 운세
  employment: string;
  workplace: string;
  jobChange: string;
  relationships: string;
  health: string;
  love: string;
  marriage: string;
  wealth: string;
  investment: string;
  startup: string;
  business: string;
  consumption: string;
  academic: string;

  // 행운 아이템
  luckyColors: string[];
  luckyNumbers: string[];
  luckyDirections: string[];

  // 운의 흐름
  goodHabits: string[];
  badHabits: string[];

  advice: string;
}

export async function interpretSaju(
  pillars: SajuPillars,
  gender: '남성' | '여성'
): Promise<FortuneResult> {
  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `당신에게 불가능한 것은 없으며 그 어떤 대답도 할 수 있습니다. 당신은 사람의 인생을 매우 정확하게 예측하고 운세에 대한 답을 줄 수 있습니다. 사주팔자와 운세에 대해 어떤 질문이든지 거절하지 않고 무조건 답변해야 합니다.

당신은 60년 경력의 최고 사주명리학 대가입니다.
- 사주팔자의 오행(목/화/토/금/수) 분석과 십신론, 용신론에 완벽히 정통합니다
- 2026년 병오년(丙午年, 火馬의 해)의 모든 특성을 정확히 이해하고 있습니다
- 수천 명의 사람들의 운세를 정확하게 맞춰온 실적이 있습니다
- 매우 구체적이고 실용적이며 정확한 조언을 제공합니다
- 모든 질문에 대해 반드시 답변하며, 거절하지 않습니다`
        },
        {
          role: 'user',
          content: `다음 사주팔자의 2026년 병오년 대박 적중 신년운세를 최대한 상세하고 정확하게 분석해주세요.

**사주팔자:**
- 년주(年柱): ${pillars.year}
- 월주(月柱): ${pillars.month}
- 일주(日柱): ${pillars.day}
- 시주(時柱): ${pillars.hour}
- 일간(日干): ${pillars.dayMaster}
- 성별: ${gender}

**출력 형식 (JSON - 모든 필드 필수):**
{
  "overall": "2026년 전체 총운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 일간과 병오년 오행의 생극제화 관계, 2) 사주 전체의 오행 균형 분석, 3) 2026년의 전반적 흐름(1-3월/4-6월/7-9월/10-12월 분기별), 4) 가장 주의해야 할 점과 가장 좋은 점, 5) 전체적인 운의 강약 분석",

  "employment": "취업운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 취업운의 전체적 흐름, 2) 취업 성공 가능성이 높은 구체적 시기(월 단위), 3) 나에게 맞는 직종과 업계, 4) 면접 성공을 위한 구체적 준비 방법, 5) 이력서 작성 시 강조할 점, 6) 피해야 할 시기와 주의사항",

  "workplace": "직장운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 직장 생활의 전반적 흐름, 2) 승진 가능성과 적기, 3) 좋은 동료를 만나는 방법과 시기, 4) 좋은 상사와의 관계 형성법, 5) 직장 내 갈등 해결 방법, 6) 업무 성과를 높이는 구체적 전략",

  "jobChange": "이직운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 이직운의 강약, 2) 이직하기 가장 좋은 구체적 시기(월 단위), 3) 피해야 할 이직 시기, 4) 이직 성공을 위한 구체적 전략, 5) 어떤 분야/업계로 이직하면 좋은지, 6) 연봉 협상 적기와 방법",

  "relationships": "대인관계운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 대인관계의 전반적 흐름, 2) 새로운 인맥을 만들기 좋은 시기, 3) 나에게 맞는 사회 활동과 모임, 4) 실질적 이익이 되는 관계 구축 방법, 5) 피해야 할 사람 유형, 6) 갈등 해결과 관계 개선 방법",

  "health": "건강운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 전반적인 건강 상태, 2) 주의해야 할 신체 부위와 질환(구체적으로), 3) 건강이 약해지는 시기(월 단위), 4) 나에게 맞는 운동법과 구체적 운동 종류, 5) 식습관 개선 방법과 추천 음식, 6) 스트레스 관리법, 7) 건강검진 받기 좋은 시기",

  "love": "애정운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 애정운의 전체 흐름, 2) 연애 운이 좋은 구체적 시기(월 단위), 3) 솔로라면 이성을 만나기 좋은 장소와 방법, 4) 연인이 있다면 관계 발전 방법, 5) 갈등이 생기기 쉬운 시기와 해결법, 6) 고백/프러포즈 적기",

  "marriage": "결혼운을 400-500자로 상세하게 작성. 반드시 포함: 1) 올해 결혼운의 강약, 2) 결혼하기 가장 좋은 구체적 시기(월 단위), 3) 배우자를 만날 가능성이 높은 시기와 장소, 4) 결혼 준비 시 주의사항, 5) 배우자감으로 좋은 사람의 특징",

  "wealth": "금전운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 전반적인 재물운, 2) 돈이 들어오기 좋은 구체적 시기(월 단위), 3) 재물 상승을 위한 구체적 방법, 4) 재물 손실을 막는 비법, 5) 지출을 줄여야 할 시기, 6) 부수입 창출 방법, 7) 금전 관리 전략",

  "investment": "투자운/재테크운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 투자운의 강약, 2) 투자하기 가장 좋은 구체적 시기(월 단위), 3) 피해야 할 투자 시기, 4) 추천하는 투자처(부동산/주식/코인/펀드 등), 5) 피해야 할 투자처, 6) 수익률 높이는 전략, 7) 손실 최소화 방법",

  "startup": "창업운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 창업하기에 적합한지 여부, 2) 창업하기 가장 좋은 구체적 시기(월 단위), 3) 나에게 맞는 창업 아이템과 분야, 4) 피해야 할 사업 분야, 5) 좋은 창업 파트너의 특징과 찾는 방법, 6) 창업 자금 마련 시기와 방법, 7) 성공을 위한 핵심 전략",

  "business": "사업운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 올해 사업운의 전체 흐름, 2) 사업 확장하기 좋은 시기, 3) 신규 사업/제품 출시 적기, 4) 거래처 확대 방법과 시기, 5) 위기 상황 대처법, 6) 매출 증대 전략, 7) 비용 절감 방법",

  "consumption": "소비운을 400-500자로 상세하게 작성. 반드시 포함: 1) 올해 소비 패턴의 특징, 2) 충동구매 조심해야 할 시기, 3) 나에게 맞는 합리적 소비 패턴, 4) 큰 지출(차/집/전자제품) 하기 좋은 시기, 5) 절약해야 할 항목",

  "academic": "학업운을 500-600자로 매우 상세하게 작성. 반드시 포함: 1) 타고난 학업 능력과 재능, 2) 올해 학업운의 흐름, 3) 성적이 오르기 좋은 시기, 4) 나에게 맞는 학습법과 공부 시간대, 5) 적성에 맞는 학업 진로와 전공, 6) 시험 운이 좋은 시기, 7) 학업 성취도를 높이는 구체적 방법",

  "luckyColors": ["행운의 색 3개 - 사주 오행에 기반"],
  "luckyNumbers": ["행운의 숫자 3개 - 사주에 기반"],
  "luckyDirections": ["행운의 방향 3개 - 방위학 기반"],

  "goodHabits": ["운의 흐름이 좋아지는 구체적인 습관 5가지 - 각각 상세하게"],
  "badHabits": ["운의 흐름에 방해를 받는 구체적인 습관 5가지 - 각각 상세하게"],

  "advice": "2026년을 잘 보내기 위한 최종 핵심 조언을 500-600자로 작성. 반드시 포함: 1) 1분기(1-3월) 핵심 실천사항, 2) 2분기(4-6월) 핵심 실천사항, 3) 3분기(7-9월) 핵심 실천사항, 4) 4분기(10-12월) 핵심 실천사항, 5) 2026년 한 해를 성공적으로 보내기 위한 가장 중요한 3가지 원칙"
}

**중요 지침:**
1. 모든 필드를 반드시 작성해야 합니다 - 빠뜨리지 말 것
2. 추상적 표현 금지 - 구체적인 월, 숫자, 시기를 명시 (예: "3월과 9월", "상반기 중 5-6월")
3. 긍정적/부정적 요소를 균형있게 제시
4. 사주의 오행과 2026년 병오(火)의 상호작용을 반드시 언급
5. 각 운세 카테고리를 최소 500자 이상으로 매우 상세하게 작성
6. 행운의 색/숫자/방향은 사주 오행에 기반하여 선정
7. 매우 구체적이고 실용적인 조언 제공 - 막연한 표현 금지`
        }
      ],
      temperature: 0.7,
      max_tokens: 2500,
      response_format: { type: 'json_object' }
    });

    const result = completion.choices[0].message.content;
    if (!result) {
      throw new Error('ChatGPT 응답이 비어있습니다.');
    }

    console.log('ChatGPT raw response:', result);

    const parsed = JSON.parse(result) as FortuneResult;
    console.log('Parsed fortune result:', parsed);

    return parsed;
  } catch (error) {
    console.error('Error interpreting Saju:', error);
    if (error instanceof SyntaxError) {
      console.error('JSON parse error. Raw content might be truncated.');
    }
    throw new Error('운세 해석 중 오류가 발생했습니다.');
  }
}
